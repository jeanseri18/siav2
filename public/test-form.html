<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Formulaire Ajout Ligne</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="csrf-token" content="test-token">
</head>
<body>
    <div class="container mt-5">
        <h2>Test Formulaire Ajout Ligne</h2>
        
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Catégorie</th>
                    <th>Sous-catégorie</th>
                    <th>Rubrique</th>
                    <th>Désignation</th>
                    <th>Unité</th>
                    <th>Quantité</th>
                    <th>Prix Unitaire HT</th>
                    <th>Montant HT</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Test Catégorie</td>
                    <td>Test Sous-catégorie</td>
                    <td>Test Rubrique</td>
                    <td colspan="6" class="text-center text-muted">Aucune ligne de déboursé</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary toggle-add-form-btn" data-rubrique-id="1">
                            Ajouter une ligne
                        </button>
                    </td>
                </tr>
                
                <!-- Formulaire d'ajout dynamique -->
                <tr id="add-form-1" style="display: none;">
                    <td colspan="3"></td>
                    <td>
                        <input type="text" name="designation" id="designation_1" class="form-control form-control-sm" required>
                    </td>
                    <td>
                        <input type="text" name="unite" id="unite_1" class="form-control form-control-sm" required>
                    </td>
                    <td>
                        <input type="number" name="quantite" id="quantite_1" class="form-control form-control-sm calculate-input" step="0.01" min="0" data-rubrique-id="1" required>
                    </td>
                    <td>
                        <input type="number" name="pu_ht" id="pu_ht_1" class="form-control form-control-sm calculate-input" step="0.01" min="0" data-rubrique-id="1" required>
                    </td>
                    <td>
                        <input type="number" name="montant_ht" id="montant_ht_1" class="form-control form-control-sm" step="0.01" readonly>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-success save-line-btn" data-rubrique-id="1">Enregistrer</button>
                        <button type="button" class="btn btn-sm btn-secondary cancel-add-form-btn" data-rubrique-id="1">Annuler</button>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <div class="mt-3">
            <h4>Console de test:</h4>
            <div id="test-console" class="bg-light p-3" style="height: 200px; overflow-y: auto; font-family: monospace;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleAddForm(rubriqueId) {
            const formRow = document.getElementById('add-form-' + rubriqueId);
            if (!formRow) {
                console.error('Form row not found for rubriqueId:', rubriqueId);
                logToConsole('ERREUR: Form row not found for rubriqueId: ' + rubriqueId);
                return;
            }
            
            console.log('Toggling form for rubriqueId:', rubriqueId);
            logToConsole('Toggling form for rubriqueId: ' + rubriqueId);
            
            if (formRow.style.display === 'none' || formRow.style.display === '') {
                formRow.style.display = 'table-row';
                logToConsole('Formulaire AFFICHÉ');
            } else {
                formRow.style.display = 'none';
                logToConsole('Formulaire CACHÉ');
            }
        }

        function calculateMontantHT(rubriqueId) {
            const quantite = parseFloat(document.getElementById('quantite_' + rubriqueId).value) || 0;
            const puHt = parseFloat(document.getElementById('pu_ht_' + rubriqueId).value) || 0;
            const montantHt = quantite * puHt;
            document.getElementById('montant_ht_' + rubriqueId).value = montantHt.toFixed(2);
            logToConsole('Montant HT calculé: ' + montantHt.toFixed(2));
        }

        function logToConsole(message) {
            const consoleDiv = document.getElementById('test-console');
            const timestamp = new Date().toLocaleTimeString();
            consoleDiv.innerHTML += `[${timestamp}] ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', function() {
            logToConsole('DOMContentLoaded fired - Test Form');
            
            // Ajouter les écouteurs d'événements pour les boutons toggleAddForm
            const toggleButtons = document.querySelectorAll('.toggle-add-form-btn');
            logToConsole('Found ' + toggleButtons.length + ' toggle buttons');
            
            toggleButtons.forEach(button => {
                logToConsole('Adding click listener to button with rubriqueId: ' + button.getAttribute('data-rubrique-id'));
                
                button.addEventListener('click', function() {
                    const rubriqueId = this.getAttribute('data-rubrique-id');
                    logToConsole('Toggle button clicked, rubriqueId: ' + rubriqueId);
                    toggleAddForm(rubriqueId);
                });
            });

            const cancelButtons = document.querySelectorAll('.cancel-add-form-btn');
            logToConsole('Found ' + cancelButtons.length + ' cancel buttons');
            
            cancelButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const rubriqueId = this.getAttribute('data-rubrique-id');
                    logToConsole('Cancel button clicked, rubriqueId: ' + rubriqueId);
                    toggleAddForm(rubriqueId);
                });
            });

            // Ajouter les écouteurs d'événements pour le calcul automatique
            document.querySelectorAll('.calculate-input').forEach(input => {
                input.addEventListener('input', function() {
                    const rubriqueId = this.getAttribute('data-rubrique-id');
                    calculateMontantHT(rubriqueId);
                });
            });

            // Gestion des boutons de sauvegarde
            document.querySelectorAll('.save-line-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const rubriqueId = this.getAttribute('data-rubrique-id');
                    logToConsole('Save button clicked for rubriqueId: ' + rubriqueId);
                    
                    // Récupérer les valeurs des champs
                    const designation = document.getElementById('designation_' + rubriqueId).value;
                    const unite = document.getElementById('unite_' + rubriqueId).value;
                    const quantite = document.getElementById('quantite_' + rubriqueId).value;
                    const puHt = document.getElementById('pu_ht_' + rubriqueId).value;
                    const montantHt = document.getElementById('montant_ht_' + rubriqueId).value;
                    
                    // Validation
                    if (!designation || !unite || !quantite || !puHt) {
                        alert('Veuillez remplir tous les champs obligatoires');
                        return;
                    }
                    
                    logToConsole('Données validées - Prêt à sauvegarder');
                    logToConsole('Désignation: ' + designation);
                    logToConsole('Unité: ' + unite);
                    logToConsole('Quantité: ' + quantite);
                    logToConsole('Prix Unitaire HT: ' + puHt);
                    logToConsole('Montant HT: ' + montantHt);
                    
                    // Simulation de la sauvegarde
                    alert('Simulation: Ligne ajoutée avec succès! (En production, cela rechargerait la page)');
                    
                    // Réinitialiser le formulaire
                    document.getElementById('designation_' + rubriqueId).value = '';
                    document.getElementById('unite_' + rubriqueId).value = '';
                    document.getElementById('quantite_' + rubriqueId).value = '';
                    document.getElementById('pu_ht_' + rubriqueId).value = '';
                    document.getElementById('montant_ht_' + rubriqueId).value = '';
                    
                    // Cacher le formulaire
                    toggleAddForm(rubriqueId);
                });
            });
        });
    </script>
</body>
</html>